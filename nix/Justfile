# Nix configuration task runner

# Default recipe
default:
    @just --list

# Switch configuration (auto-detects NixOS vs Home Manager)
switch:
    #!/usr/bin/env bash
    set -euo pipefail
    host=$(hostname | sed 's/\.local$//')
    if [ -f /etc/NIXOS ]; then
        echo "NixOS detected, running nixos-rebuild switch..."
        sudo nixos-rebuild switch --flake ".#$host"
    else
        echo "Standalone Home Manager detected, running home-manager switch..."
        home-manager switch -b bak --flake ".#$host"
    fi

# Build on this machine and deploy/switch on a remote NixOS host
deploy target:
    nixos-rebuild switch --flake ".#{{target}}" --build-host "" --target-host "{{target}}" --sudo

# Dry-run NixOS rebuild (NixOS only)
dry:
    sudo nixos-rebuild dry-run --flake ".#$(hostname)"

# Build and show what changed (NixOS only)
diff:
    #!/usr/bin/env bash
    set -euo pipefail
    host=$(hostname)
    sudo nixos-rebuild build --flake ".#$host" && nvd diff /run/current-system result

# Evaluate config without building (auto-detects NixOS vs Home Manager)
eval:
    #!/usr/bin/env bash
    set -euo pipefail
    host=$(hostname | sed 's/\.local$//')
    if [ -f /etc/NIXOS ]; then
        echo "Evaluating NixOS config for $host..."
        nix eval ".#nixosConfigurations.$host.config.system.build.toplevel" --no-write-lock-file > /dev/null
    else
        echo "Evaluating Home Manager config for $host..."
        nix eval ".#homeConfigurations.$host.activationPackage" --no-write-lock-file > /dev/null
    fi
    echo "Config is valid"

# Evaluate all host configurations
eval-all:
    #!/usr/bin/env bash
    set -euo pipefail
    failed=0

    echo "==> Evaluating NixOS configurations..."
    for host in thinkpad thrawny-desktop; do
        echo -n "  $host: "
        if nix eval ".#nixosConfigurations.$host.config.system.build.toplevel" --no-write-lock-file > /dev/null 2>&1; then
            echo "ok"
        else
            echo "FAILED"
            failed=1
        fi
    done

    echo ""
    echo "==> Evaluating Home Manager configurations..."
    for host in thrawnym1 thrawny-asahi-air; do
        echo -n "  $host: "
        if nix eval ".#homeConfigurations.$host.activationPackage" --no-write-lock-file > /dev/null 2>&1; then
            echo "ok"
        else
            echo "FAILED"
            failed=1
        fi
    done

    echo ""
    if [ $failed -eq 0 ]; then
        echo "All configurations valid!"
    else
        echo "Some configurations failed!"
        exit 1
    fi

# Update AI tool flake inputs (claude-code-nix, llm-agents) and switch
ai:
    nix flake update claude-code-nix llm-agents
    just switch

# Clean up old generations (keeps last 6) and optimize store
clean:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "==> Checking /nix/store size before cleanup..."
    du -sh /nix/store

    echo ""
    echo "==> Removing old user profile generations (keeping last 6)..."
    nix-env --delete-generations +6

    echo ""
    echo "==> Removing old system generations (keeping last 6)..."
    sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +6 || true

    echo ""
    echo "==> Running garbage collection..."
    nix-collect-garbage

    echo ""
    echo "==> Optimizing Nix store (deduplicating files)..."
    nix store optimise

    echo ""
    echo "==> Cleanup complete! Final /nix/store size:"
    du -sh /nix/store

# Format Nix files
fmt:
    nix fmt .

# Lint Nix files
lint:
    statix check .

# Format, lint, and evaluate current host
check: fmt lint eval

# Format, lint, and evaluate all hosts
check-all: fmt lint eval-all
