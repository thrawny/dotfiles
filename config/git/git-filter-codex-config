#!/usr/bin/env bash
# Git filter for config/codex/config.toml
# clean: keep everything up to (and including) the sentinel line, dropping content below
# smudge: append local overlay (if any) under the sentinel; avoid duplicating the sentinel

set -euo pipefail

cmd="${1:-clean}"

case "$cmd" in
  clean)
    awk 'x{next} {print} /^# *@local-only-below/ {x=1}'
    ;;
  smudge)
    overlay="config/codex/config.local.toml"
    tmp=$(mktemp)
    cat > "$tmp"
    if [ -f "$overlay" ] && [ -s "$overlay" ]; then
      cat "$tmp"
      if grep -qE '^# *@local-only-below' "$tmp"; then
        printf "\n"
      else
        printf "\n# @local-only-below\n"
      fi
      cat "$overlay"
    else
      cat "$tmp"
    fi
    rm -f "$tmp"
    ;;
  *)
    echo "unknown subcommand: $cmd" >&2
    exit 2
    ;;
esac
