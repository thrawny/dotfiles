# --- Nix workflows ---
# Auto-detect NixOS vs standalone Home Manager by checking /etc/NIXOS
experimental_monorepo_root = true

[tasks.switch]
description = "Switch configuration (auto-detects NixOS vs Home Manager)"
run = '''
host=$(hostname | sed 's/\.local$//')
if [ -f /etc/NIXOS ]; then
  echo "NixOS detected, running nixos-rebuild switch..."
  sudo nixos-rebuild switch --flake "./nix#$host"
else
  echo "Standalone Home Manager detected, running home-manager switch..."
  home-manager switch --flake "./nix#$host"
fi
'''
sources = ["nix/**/*.nix", "nix/flake.*", "niri-switcher/**/*"]

[tasks.dry]
description = "Dry-run NixOS rebuild (NixOS only)"
run = '''
host=$(hostname)
sudo nixos-rebuild dry-run --flake "./nix#$host"
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks.diff]
description = "Build and show what changed (NixOS only)"
run = '''
host=$(hostname)
sudo nixos-rebuild build --flake "./nix#$host" && nvd diff /run/current-system result
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks."nix:clean"]
description = "Clean up old Nix generations (keeps last 6) and optimize store"
run = '''
echo "==> Checking /nix/store size before cleanup..."
du -sh /nix/store

echo ""
echo "==> Removing old user profile generations (keeping last 6)..."
nix-env --delete-generations +6

echo ""
echo "==> Removing old system generations (keeping last 6)..."
sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +6 || true

echo ""
echo "==> Running garbage collection..."
nix-collect-garbage

echo ""
echo "==> Optimizing Nix store (deduplicating files)..."
nix store optimise

echo ""
echo "==> Cleanup complete! Final /nix/store size:"
du -sh /nix/store
'''

# --- Formatters ---
# Python formatting
[tasks."fmt:python"]
description = "Format Python sources with Ruff"
run = "uv run ruff check --fix && uv run ruff format ."
outputs = { auto = true }

# Lua formatting
[tasks."fmt:lua"]
description = "Format Neovim Lua config with Stylua"
run = "stylua config/nvim"
sources = ["config/nvim/**/*.lua"]
outputs = { auto = true }

# Nix formatting
[tasks."fmt:nix"]
description = "Format Nix files with nixfmt"
run = "nix shell nixpkgs#treefmt nixpkgs#nixfmt -c treefmt"
sources = ["**/*.nix"]
outputs = { auto = true }

# Nix format + lint + eval combined
[tasks."nix:check"]
description = "Format, lint, and evaluate Nix config"
depends = ["fmt:nix", "lint:nix", "nix:eval"]

[tasks."nix:eval"]
description = "Evaluate Nix config without building (auto-detects NixOS vs Home Manager)"
run = '''
host=$(hostname | sed 's/\.local$//')
if [ -f /etc/NIXOS ]; then
  echo "Evaluating NixOS config for $host..."
  nix eval "./nix#nixosConfigurations.$host.config.system.build.toplevel" --no-write-lock-file > /dev/null && echo "Config is valid"
else
  echo "Evaluating Home Manager config for $host..."
  nix eval "./nix#homeConfigurations.$host.activationPackage" --no-write-lock-file > /dev/null && echo "Config is valid"
fi
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

# --- Linters ---
[tasks."lint:python"]
description = "Lint Python sources with Ruff"
run = "uv run ruff check ."

[tasks."lint:lua"]
description = "Lint Neovim Lua config with Selene"
run = "selene config/nvim"
sources = ["config/nvim/**/*.lua"]

[tasks."lint:nix"]
description = "Lint Nix files with statix"
run = "statix check"
sources = ["**/*.nix"]

# --- Typechecking ---
[tasks."typecheck:python"]
description = "Typecheck Python code with basedpyright"
run = "uv run basedpyright"

# --- Tests ---
[tasks."test:nvim"]
description = "Run Neovim config tests in headless mode"
run = '''
nvim --headless -u config/nvim/init.lua \
  +"lua local ok,tests=pcall(require,'tests'); if ok and tests.run_all then tests.run_all() end" \
  +qa
'''
sources = ["config/nvim/**/*.lua"]

# --- Aggregates ---
[tasks.fmt]
description = "Run all formatters"
depends = ["fmt:python", "fmt:lua", "fmt:nix"]
alias = "f"

[tasks.lint]
description = "Run all linters"
depends = ["lint:python", "lint:lua", "lint:nix"]

[tasks.typecheck]
description = "Run all type checks"
depends = ["typecheck:python"]

[tasks.test]
description = "Run all tests"
depends = ["test:nvim"]

[tasks.ci]
description = "Run lint, typecheck, format, and tests"
depends = ["fmt", "lint", "typecheck", "test"]

# --- Tools ---
[tools]
"nix:nixfmt" = "latest"
"nix:nvd" = "latest"
"nix:selene" = "latest"
"nix:statix" = "latest"
"nix:stylua" = "latest"
