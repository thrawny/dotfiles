# --- Nix workflows ---
[tasks.switch]
description = "Rebuild and switch NixOS configuration for this host"
run = '''
host=$(hostname)
sudo nixos-rebuild switch --flake "./nix#$host"
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks.dry]
description = "Dry-run the NixOS rebuild for this host"
run = '''
host=$(hostname)
sudo nixos-rebuild dry-run --flake "./nix#$host"
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks.diff]
description = "Build new config and show what changed (packages, versions, etc.)"
run = '''
host=$(hostname)
sudo nixos-rebuild build --flake "./nix#$host" && nvd diff /run/current-system result
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks."switch-darwin"]
description = "Switch Home Manager configuration on macOS"
run = '''
host=$(hostname | sed 's/\.local$//')
home-manager switch --flake "./nix#$host"
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks.iso]
description = "Build desktop installer ISO with network drivers"
run = '''
nix build ./nix#packages.x86_64-linux.desktop-iso
echo "ISO created at: ./result/iso/"
echo "Write to USB with: sudo dd if=./result/iso/*.iso of=/dev/sdX bs=4M status=progress"
'''
sources = ["nix/**/*.nix", "nix/flake.*"]

[tasks."nix:clean"]
description = "Clean up old Nix generations and optimize store"
run = '''
echo "==> Checking /nix/store size before cleanup..."
du -sh /nix/store

echo ""
echo "==> Removing old user profile generations..."
nix-collect-garbage -d

echo ""
echo "==> Removing old system generations (NixOS only)..."
sudo nix-collect-garbage -d || true

echo ""
echo "==> Optimizing Nix store (deduplicating files)..."
nix store optimise

echo ""
echo "==> Cleanup complete! Final /nix/store size:"
du -sh /nix/store
'''

# --- Formatters ---
# Python formatting
[tasks."fmt:python"]
description = "Format Python sources with Ruff"
run = "uv run ruff check --fix && uv run ruff format ."
outputs = { auto = true }

# Lua formatting
[tasks."fmt:lua"]
description = "Format Neovim Lua config with Stylua"
run = "stylua config/nvim"
sources = ["config/nvim/**/*.lua"]
outputs = { auto = true }

# Nix formatting
[tasks."fmt:nix"]
description = "Format Nix files with nixfmt"
run = "nix shell nixpkgs#treefmt nixpkgs#nixfmt -c treefmt"
sources = ["**/*.nix"]
outputs = { auto = true }

# --- Linters ---
[tasks."lint:python"]
description = "Lint Python sources with Ruff"
run = "uv run ruff check ."

[tasks."lint:lua"]
description = "Lint Neovim Lua config with Selene"
run = "selene config/nvim"
sources = ["config/nvim/**/*.lua"]

[tasks."lint:nix"]
description = "Lint Nix files with statix"
run = "statix check"
sources = ["**/*.nix"]

# --- Typechecking ---
[tasks."typecheck:python"]
description = "Typecheck Python code with basedpyright"
run = "uv run basedpyright"

# --- Tests ---
[tasks."test:nvim"]
description = "Run Neovim config tests in headless mode"
run = '''
nvim --headless -u config/nvim/init.lua \
  +"lua local ok,tests=pcall(require,'tests'); if ok and tests.run_all then tests.run_all() end" \
  +qa
'''
sources = ["config/nvim/**/*.lua"]

# --- Aggregates ---
[tasks.fmt]
description = "Run all formatters"
depends = ["fmt:python", "fmt:lua", "fmt:nix"]
alias = "f"

[tasks.lint]
description = "Run all linters"
depends = ["lint:python", "lint:lua", "lint:nix"]

[tasks.typecheck]
description = "Run all type checks"
depends = ["typecheck:python"]

[tasks.test]
description = "Run all tests"
depends = ["test:nvim"]

[tasks.ci]
description = "Run lint, typecheck, format, and tests"
depends = ["fmt", "lint", "typecheck", "test"]

# --- Tools ---
[tools]
"nix:nixfmt" = "latest"
"nix:nvd" = "latest"
"nix:selene" = "latest"
"nix:statix" = "latest"
"nix:stylua" = "latest"
