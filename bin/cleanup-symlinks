#!/bin/bash
# Cleanup script to remove existing symlinks and directories
# that might conflict with Ansible's folder-based symlinks

set -euo pipefail

echo "ðŸ§¹ Cleaning up existing symlinks and directories for dotfiles setup..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to safely remove symlink or directory
safe_remove() {
    local path="$1"
    local description="$2"
    
    if [[ -L "$path" ]]; then
        echo -e "${YELLOW}Removing symlink: ${path}${NC}"
        rm -f "$path"
    elif [[ -d "$path" ]]; then
        echo -e "${YELLOW}Removing directory: ${path}${NC}"
        rm -rf "$path"
    elif [[ -f "$path" ]]; then
        echo -e "${YELLOW}Removing file: ${path}${NC}"
        rm -f "$path"
    else
        echo -e "${GREEN}âœ“ ${description} - nothing to clean${NC}"
        return
    fi
    echo -e "${GREEN}âœ“ ${description} - cleaned${NC}"
}

# Create ~/.config if it doesn't exist
mkdir -p ~/.config

echo ""
echo "Cleaning up .config symlinks/directories..."

# Clean up config directories that will become folder symlinks
safe_remove ~/.config/direnv "Direnv config"
safe_remove ~/.config/ghostty "Ghostty config"
safe_remove ~/.config/starship "Starship config (file)"
safe_remove ~/.config/starship.toml "Starship config (directory)"  
safe_remove ~/.config/nvim "Neovim config"
safe_remove ~/.config/k9s "K9s config"

echo ""
echo "Cleaning up home directory symlinks..."

# Clean up individual file symlinks that will become folder-based
safe_remove ~/.ideavimrc "IntelliJ Vim config"
safe_remove ~/.vim "Vim config"
safe_remove ~/.default-npm-packages "Default npm packages"

# Clean up aerospace config if it exists as wrong type
safe_remove ~/.aerospace.toml "Aerospace config"

echo ""
echo "Cleaning up Cursor config (macOS only)..."
if [[ "$OSTYPE" == "darwin"* ]]; then
    cursor_dir="$HOME/Library/Application Support/Cursor/User"
    safe_remove "$cursor_dir/settings.json" "Cursor settings"
    safe_remove "$cursor_dir/keybindings.json" "Cursor keybindings"
fi

echo ""
echo -e "${GREEN}ðŸŽ‰ Cleanup complete! You can now run: ansible-playbook ansible/main.yml${NC}"