#!/usr/bin/env bash

[[ "${TRACE}" ]] && set -x
set -euo pipefail

DEV_SESSION="dev"

error() {
  echo "Error: $*" >&2
  return 1
}

show_usage() {
  echo "Usage: tmux-dev-server-control <action> [options]"
  echo ""
  echo "All processes run as windows in the '$DEV_SESSION' tmux session."
  echo "Window names are auto-generated from directory + command."
  echo ""
  echo "Actions:"
  echo "  start <command...>   - Start a dev server (name auto-generated)"
  echo "  stop <name>          - Stop a dev server window"
  echo "  logs <name> [lines]  - Show recent logs from window"
  echo "  list                 - List all dev server windows"
  echo ""
  echo "Examples:"
  echo "  cd ~/code/myapp && tmux-dev-server-control start npm run dev"
  echo "    -> creates window 'myapp-npm-dev'"
  echo ""
  echo "  tmux-dev-server-control logs myapp-npm-dev 100"
  echo "  tmux-dev-server-control stop myapp-npm-dev"
  echo "  tmux-dev-server-control list"
  echo ""
  echo "Attach to session: tmux attach -t $DEV_SESSION"
}

validate_command() {
  local command="$*"

  local allowed_patterns=(
    "^npm (run|start)"
    "^yarn (dev|start|build)"
    "^pnpm (dev|start|build)"
    "^npx " "^node " "^bun "
    "^go run" "^go build"
    "^python" "^python3"
    "^flask run" "^uvicorn " "^gunicorn " "^uv run "
    "^docker-compose up" "^docker compose up" "^docker run"
    "^make "
    "^./scripts/" "^bin/"
  )

  for pattern in "${allowed_patterns[@]}"; do
    if [[ "$command" =~ $pattern ]]; then
      return 0
    fi
  done

  error "Command not allowed: $command"
}

session_exists() {
  tmux has-session -t "$DEV_SESSION" 2>/dev/null
}

window_exists() {
  tmux list-windows -t "$DEV_SESSION" -F "#{window_name}" 2>/dev/null | grep -qx "$1"
}

ensure_session() {
  if ! session_exists; then
    tmux new-session -d -s "$DEV_SESSION" -n "_placeholder"
  fi
}

generate_name() {
  local command="$*"
  local folder
  folder=$(basename "$PWD")

  local cmd_words=($command)
  local main_cmd="${cmd_words[0]}"
  local slug=""

  case "$main_cmd" in
    npm|yarn|pnpm|bun)
      if [[ "${cmd_words[1]:-}" == "run" ]]; then
        slug="${main_cmd}-${cmd_words[2]:-run}"
      else
        slug="${main_cmd}-${cmd_words[1]:-start}"
      fi
      ;;
    go)
      if [[ "${cmd_words[1]:-}" == "run" ]]; then
        local path="${cmd_words[2]:-main}"
        if [[ "$path" == *"/main.go" ]]; then
          path="${path%/main.go}"
          path="${path##*/}"
        else
          path="${path##*/}"
          path="${path%.go}"
        fi
        slug="go-${path}"
      else
        slug="go-${cmd_words[1]:-build}"
      fi
      ;;
    python|python3|uv)
      local script="${cmd_words[1]:-main}"
      [[ "$script" == "run" ]] && script="${cmd_words[2]:-main}"
      script="${script##*/}"
      script="${script%.py}"
      slug="py-${script}"
      ;;
    make)
      slug="${cmd_words[1]:-make}"
      ;;
    *)
      slug="${main_cmd}${cmd_words[1]:+-${cmd_words[1]}}"
      ;;
  esac

  slug="${slug,,}"
  slug="${slug//[^a-z0-9-]/-}"

  # Strip noise words (start, dev, run, make) from slug
  local noise_words=("start" "dev" "run" "make")
  for word in "${noise_words[@]}"; do
    slug="${slug//-${word}-/-}"  # -word- -> -
    slug="${slug/#${word}-/}"    # word- at start -> empty
    slug="${slug/%-${word}/}"    # -word at end -> empty
  done

  slug="${slug//--/-}"
  slug="${slug#-}"
  slug="${slug%-}"

  echo "${folder}-${slug}"
}

handle_start() {
  if [[ $# -lt 1 ]]; then
    error "start requires command
Usage: tmux-dev-server-control start <command...>"
  fi

  local command="$*"
  local name
  name=$(generate_name "$command")

  validate_command "$command" || return 1

  ensure_session

  if window_exists "$name"; then
    echo "Window '$name' already exists"
    echo ""
    echo "Recent logs:"
    tmux capture-pane -t "$DEV_SESSION:$name" -p -S - | grep -v '^$' | tail -10
    echo ""
    echo "Use 'stop $name' first, or 'logs $name' for more output"
    return 1
  fi

  local cwd="$PWD"
  echo "Starting '$name': $command"
  # Wrap command to keep window open on exit (success or failure)
  # Trailing colon forces tmux to auto-pick window index in the specified session
  tmux new-window -t "${DEV_SESSION}:" -n "$name" -c "$cwd" \
    "bash -c '${command}; echo; echo \"=== Exited with code: \$?\"; read -p \"Press enter to close...\"'"

  # Clean up placeholder window if it exists
  if tmux list-windows -t "$DEV_SESSION" -F "#{window_name}" | grep -qx "_placeholder"; then
    tmux kill-window -t "$DEV_SESSION:_placeholder" 2>/dev/null || true
  fi

  sleep 1
  if window_exists "$name"; then
    echo "✓ Window '$name' started in session '$DEV_SESSION'"
  else
    echo "✗ Window exited immediately"
    echo "Try running manually: cd $cwd && $command"
    return 1
  fi
}

handle_stop() {
  if [[ $# -lt 1 ]]; then
    error "stop requires window name"
  fi

  local name="$1"

  if ! session_exists; then
    echo "No dev session exists"
    return 1
  fi

  if ! window_exists "$name"; then
    echo "Window '$name' does not exist"
    return 1
  fi

  tmux kill-window -t "$DEV_SESSION:$name"
  echo "✓ Window '$name' stopped"
}

handle_logs() {
  if [[ $# -lt 1 ]]; then
    error "logs requires window name"
  fi

  local name="$1"
  local lines="${2:-50}"

  if ! session_exists || ! window_exists "$name"; then
    echo "Window '$name' does not exist"
    handle_list
    return 1
  fi

  echo "=== $name (last $lines lines) ==="
  tmux capture-pane -t "$DEV_SESSION:$name" -p -S - | grep -v '^$' | tail -n "$lines"
}

handle_list() {
  if ! session_exists; then
    echo "No dev server session"
    return 0
  fi

  local windows
  windows=$(tmux list-windows -t "$DEV_SESSION" -F "#{window_name}" | grep -v "^_placeholder$" || true)

  if [[ -z "$windows" ]]; then
    echo "No dev server windows"
    return 0
  fi

  echo "Dev server windows (session: $DEV_SESSION):"
  while IFS= read -r name; do
    echo "  $name"
  done <<< "$windows"
  echo ""
  echo "Attach: tmux attach -t $DEV_SESSION"
}

main() {
  if [[ $# -lt 1 ]]; then
    show_usage
    return 1
  fi

  local action="$1"
  shift

  case "$action" in
    start) handle_start "$@" ;;
    stop) handle_stop "$@" ;;
    logs) handle_logs "$@" ;;
    list) handle_list ;;
    *)
      echo "Unknown action: $action"
      show_usage
      return 1
      ;;
  esac
}

main "$@"
