#!/usr/bin/env python3
"""Cross-platform visual notifications for macOS and Linux.

Usage:
    notify "message"
    notify --sound "message"  # also play sound

Title is automatically set to the current directory name.

Behavior:
- macOS: uses terminal-notifier (brew install terminal-notifier)
- Linux: uses notify-send if available (common on desktop distros)

Environment variables:
- NOTIFY_SOUND: if set to "1", also plays sound (or use --sound flag)
"""

from __future__ import annotations

import argparse
import os
import platform
import shutil
import subprocess
import sys


def notify_macos(title: str, message: str) -> bool:
    if not shutil.which("terminal-notifier"):
        print("terminal-notifier not found. Install with: brew install terminal-notifier", file=sys.stderr)
        return False
    try:
        subprocess.run(
            ["terminal-notifier", "-title", title, "-message", message],
            check=True,
            capture_output=True,
            timeout=5,
        )
        return True
    except Exception:
        return False


def notify_linux(title: str, message: str) -> bool:
    if not shutil.which("notify-send"):
        print("notify-send not found. Install libnotify.", file=sys.stderr)
        return False
    try:
        subprocess.run(
            ["notify-send", title, message],
            check=True,
            capture_output=True,
            timeout=5,
        )
        return True
    except Exception:
        return False


def play_sound() -> None:
    system = platform.system()
    if system == "Darwin":
        sound_file = os.environ.get("NOTIFY_SOUND_FILE", "/System/Library/Sounds/Glass.aiff")
        volume = os.environ.get("NOTIFY_VOLUME", "1.5")
        try:
            subprocess.run(
                ["/usr/bin/afplay", "-v", volume, sound_file],
                check=False,
                capture_output=True,
                timeout=5,
            )
        except Exception:
            pass


def main() -> int:
    parser = argparse.ArgumentParser(description="Cross-platform notifications")
    parser.add_argument("message", help="Notification message")
    parser.add_argument("--sound", "-s", action="store_true", help="Also play sound")
    args = parser.parse_args()

    title = os.path.basename(os.getcwd())
    message = args.message

    want_sound = args.sound or os.environ.get("NOTIFY_SOUND") == "1"

    system = platform.system()
    success = False

    if system == "Darwin":
        success = notify_macos(title, message)
    elif system == "Linux":
        success = notify_linux(title, message)

    if want_sound:
        play_sound()

    return 0 if success else 1


if __name__ == "__main__":
    sys.exit(main())
